<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙ„Ù‘Ø­Ù„ÙŠ | Sallehly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .screen {
            transition: opacity 0.3s ease-in-out;
        }
        .hidden-screen, .modal-hidden {
            display: none;
            opacity: 0;
        }
        .visible-screen, .modal-visible {
            display: block;
            opacity: 1;
        }
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .modal-visible .modal-content {
            transform: translateY(0);
        }
        .modal-hidden .modal-content {
            transform: translateY(-20px);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #0369a1; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #0284c7; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #0ea5e9; /* sky-500 */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Main Application Container -->
    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col">

        <!-- Header -->
        <header id="app-header" class="bg-sky-700 text-white p-4 flex justify-between items-center shadow-md hidden sticky top-0 z-10">
            <div class="flex items-center space-x-2 rtl:space-x-reverse">
                 <button id="back-button" class="hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rtl:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 class="text-xl font-bold">
                    <span class="text-orange-400">ØµÙ„Ù‘Ø­Ù„ÙŠ</span> | Sallehly
                </h1>
            </div>
            <button id="lang-toggle" class="text-sm font-semibold border-2 border-white rounded-full px-3 py-1 hover:bg-white hover:text-sky-700 transition">
                English
            </button>
        </header>

        <!-- Screens Container -->
        <main class="flex-grow p-4 md:p-6 overflow-y-auto">

            <!-- Login Screen -->
            <div id="login-screen" class="screen visible-screen flex flex-col justify-center items-center h-full">
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-bold text-sky-700">
                        <span class="text-orange-400" data-translate-key="sallehly_ar">ØµÙ„Ù‘Ø­Ù„ÙŠ</span>
                        <span data-translate-key="sallehly_en">Sallehly</span>
                    </h2>
                    <p class="text-slate-500 mt-2" data-translate-key="login_subtitle">Ø£Ø³Ù‡Ù„ Ø·Ø±ÙŠÙ‚Ø© Ù„Ø®Ø¯Ù…Ø§Øª ØµÙŠØ§Ù†Ø© Ø¨ÙŠØªÙƒ</p>
                </div>
                <div class="w-full max-w-sm">
                     <p id="login-error" class="text-red-500 text-sm text-center mb-2 h-4"></p>
                    <div class="mb-4">
                        <label for="name" class="block text-slate-700 text-sm font-bold mb-2" data-translate-key="full_name_label">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input id="name" type="text" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" data-translate-key-placeholder="name_placeholder" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div class="mb-6">
                        <label for="phone" class="block text-slate-700 text-sm font-bold mb-2" data-translate-key="phone_label">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
                        <input id="phone" type="tel" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ" data-translate-key-placeholder="phone_placeholder" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <button id="login-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition transform hover:scale-105" data-translate-key="login_button">
                        Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„
                    </button>
                </div>
                 <button id="login-lang-toggle" class="mt-8 text-sky-600 underline">English</button>
            </div>

            <!-- Home Screen -->
            <div id="home-screen" class="screen hidden-screen">
                <h2 class="text-2xl font-bold text-slate-800 mb-2" data-translate-key="welcome_message">Ù…Ø±Ø­Ø¨Ø§Ù‹, <span id="user-name-display"></span>!</h2>
                <p class="text-slate-500 mb-6" data-translate-key="home_subtitle">Ø§Ø®ØªØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù„ÙŠ Ù…Ø­ØªØ§Ø¬Ù‡Ø§</p>
                <div id="services-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <!-- Service cards will be injected here by JS -->
                </div>
            </div>

            <!-- Request Form Screen -->
            <div id="request-form-screen" class="screen hidden-screen">
                <h2 class="text-2xl font-bold text-slate-800 mb-4" data-translate-key="request_service_title">Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø©</h2>
                <form id="service-request-form">
                    <input type="hidden" id="service-type-hidden">
                    <div class="mb-4">
                        <label class="block text-slate-700 text-sm font-bold mb-2" data-translate-key="service_type_label">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                        <p id="service-type-display" class="w-full bg-slate-100 text-slate-800 font-semibold p-3 rounded-lg"></p>
                    </div>
                    <div class="mb-4">
                        <label for="address" class="block text-slate-700 text-sm font-bold mb-2" data-translate-key="address_label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„</label>
                        <input type="text" id="address" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500" data-translate-key-placeholder="address_placeholder" placeholder="Ù…Ø«Ø§Ù„: Ù¡Ù  Ø´Ø§Ø±Ø¹ ...ØŒ Ø§Ù„Ø¯ÙˆØ± Ù£ØŒ Ø´Ù‚Ø© Ù¥">
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label for="description" class="block text-slate-700 text-sm font-bold" data-translate-key="problem_description_label">ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
                            <button type="button" id="describe-helper-btn" class="text-xs text-sky-600 font-semibold flex items-center space-x-1 rtl:space-x-reverse">
                                <span data-translate-key="gemini_describe_helper">âœ¨ Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙÙŠ Ø§Ù„ÙˆØµÙ</span>
                            </button>
                        </div>
                        <textarea id="description" rows="4" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-sky-500" data-translate-key-placeholder="problem_description_placeholder" placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."></textarea>
                    </div>
                     <div class="mb-4 text-center">
                        <button type="button" id="diy-helper-btn" class="w-full bg-sky-100 text-sky-700 font-bold py-2 px-4 rounded-lg focus:outline-none hover:bg-sky-200 transition transform hover:scale-105 flex items-center justify-center space-x-2 rtl:space-x-reverse">
                             <span data-translate-key="gemini_diy_helper">âœ¨ Ø§Ù‚ØªØ±Ø§Ø­ Ø¥ØµÙ„Ø§Ø­ Ø³Ø±ÙŠØ¹</span>
                        </button>
                    </div>
                    <div class="mb-6">
                        <label for="media-upload" class="block text-slate-700 text-sm font-bold mb-2" data-translate-key="upload_label">Ø§Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="file" id="media-upload" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 rtl:file:ml-4">
                    </div>
                    <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition transform hover:scale-105" data-translate-key="submit_request_button">
                        ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </form>
            </div>

            <!-- My Requests Screen -->
            <div id="my-requests-screen" class="screen hidden-screen">
                <h2 class="text-2xl font-bold text-slate-800 mb-4" data-translate-key="my_requests_title">Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
                <div id="requests-list" class="space-y-4">
                    <!-- Request items will be injected here -->
                </div>
            </div>

        </main>

        <!-- Footer / Navigation Bar -->
        <footer id="app-footer" class="bg-white border-t border-slate-200 p-2 flex justify-around hidden sticky bottom-0 z-10">
            <button class="nav-button text-sky-700 flex flex-col items-center w-full py-2 rounded-lg" data-target="home-screen">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span class="text-xs font-semibold" data-translate-key="nav_home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </button>
            <button class="nav-button text-slate-500 flex flex-col items-center w-full py-2 rounded-lg" data-target="my-requests-screen">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs font-semibold" data-translate-key="nav_requests">Ø·Ù„Ø¨Ø§ØªÙŠ</span>
            </button>
        </footer>

    </div>

    <!-- Universal Modal -->
    <div id="modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <div id="modal-loading" class="hidden">
                <div class="spinner mx-auto"></div>
                <p class="mt-4 text-slate-600 font-semibold" data-translate-key="gemini_loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
            <div id="modal-content-display">
                <h3 id="modal-title" class="text-lg font-bold text-slate-800 mb-2"></h3>
                <div id="modal-body" class="text-sm text-slate-600 text-left rtl:text-right max-h-60 overflow-y-auto"></div>
                <button id="modal-close-btn" class="mt-6 w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">
                    Ok
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE MANAGEMENT ---
            let state = {
                currentUser: null,
                currentLang: 'ar',
                currentScreen: 'login',
                requests: [],
            };

            // --- DOM ELEMENTS ---
            const dom = {
                html: document.documentElement,
                header: document.getElementById('app-header'),
                footer: document.getElementById('app-footer'),
                backButton: document.getElementById('back-button'),
                langToggle: document.getElementById('lang-toggle'),
                loginLangToggle: document.getElementById('login-lang-toggle'),
                userNameDisplay: document.getElementById('user-name-display'),
                screens: {
                    login: document.getElementById('login-screen'),
                    home: document.getElementById('home-screen'),
                    requestForm: document.getElementById('request-form-screen'),
                    myRequests: document.getElementById('my-requests-screen'),
                },
                loginForm: {
                    name: document.getElementById('name'),
                    phone: document.getElementById('phone'),
                    button: document.getElementById('login-button'),
                    error: document.getElementById('login-error'),
                },
                servicesGrid: document.getElementById('services-grid'),
                requestForm: {
                    form: document.getElementById('service-request-form'),
                    serviceTypeHidden: document.getElementById('service-type-hidden'),
                    serviceTypeDisplay: document.getElementById('service-type-display'),
                    address: document.getElementById('address'),
                    description: document.getElementById('description'),
                    mediaUpload: document.getElementById('media-upload'),
                    describeHelperBtn: document.getElementById('describe-helper-btn'),
                    diyHelperBtn: document.getElementById('diy-helper-btn'),
                },
                requestsList: document.getElementById('requests-list'),
                navButtons: document.querySelectorAll('.nav-button'),
                modal: {
                    container: document.getElementById('modal'),
                    loading: document.getElementById('modal-loading'),
                    contentDisplay: document.getElementById('modal-content-display'),
                    title: document.getElementById('modal-title'),
                    body: document.getElementById('modal-body'),
                    closeBtn: document.getElementById('modal-close-btn'),
                }
            };

            // --- TRANSLATIONS & DATA ---
            const translations = {
                ar: {
                    lang_toggle: 'English',
                    sallehly_ar: 'ØµÙ„Ù‘Ø­Ù„ÙŠ',
                    sallehly_en: 'Sallehly',
                    login_subtitle: 'Ø£Ø³Ù‡Ù„ Ø·Ø±ÙŠÙ‚Ø© Ù„Ø®Ø¯Ù…Ø§Øª ØµÙŠØ§Ù†Ø© Ø¨ÙŠØªÙƒ',
                    full_name_label: 'Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„',
                    name_placeholder: 'Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ',
                    phone_label: 'Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„',
                    phone_placeholder: 'Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ',
                    login_button: 'Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„',
                    welcome_message: 'Ù…Ø±Ø­Ø¨Ø§Ù‹,',
                    home_subtitle: 'Ø§Ø®ØªØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù„ÙŠ Ù…Ø­ØªØ§Ø¬Ù‡Ø§',
                    request_service_title: 'Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø©',
                    service_type_label: 'Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©',
                    address_label: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„',
                    address_placeholder: 'Ù…Ø«Ø§Ù„: Ù¡Ù  Ø´Ø§Ø±Ø¹ ...ØŒ Ø§Ù„Ø¯ÙˆØ± Ù£ØŒ Ø´Ù‚Ø© Ù¥',
                    problem_description_label: 'ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©',
                    problem_description_placeholder: 'Ø§ÙƒØªØ¨ ÙˆØµÙ Ø¨Ø³ÙŠØ· Ù„Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§...',
                    upload_label: 'Ø§Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
                    submit_request_button: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨',
                    my_requests_title: 'Ø·Ù„Ø¨Ø§ØªÙŠ',
                    nav_home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
                    nav_requests: 'Ø·Ù„Ø¨Ø§ØªÙŠ',
                    status_new: 'Ø¬Ø¯ÙŠØ¯',
                    status_in_progress: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
                    status_completed: 'Ù…ÙƒØªÙ…Ù„',
                    request_id: 'Ø·Ù„Ø¨ Ø±Ù‚Ù…',
                    no_requests: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ©. Ø§Ø¨Ø¯Ø£ Ø¨Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©!',
                    fill_all_fields: 'Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„',
                    request_submitted_success: 'ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!',
                    gemini_describe_helper: 'âœ¨ Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙÙŠ Ø§Ù„ÙˆØµÙ',
                    gemini_diy_helper: 'âœ¨ Ø§Ù‚ØªØ±Ø§Ø­ Ø¥ØµÙ„Ø§Ø­ Ø³Ø±ÙŠØ¹',
                    gemini_loading: 'Ù„Ø­Ø¸Ø§ØªØŒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙÙƒØ±...',
                    gemini_diy_title: 'ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø³Ø±ÙŠØ¹',
                    gemini_safety_warning: 'âš ï¸ Ø§Ù†ØªØ¨Ù‡! Ù‡Ø°Ù‡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ÙÙ‚Ø·. Ø³Ù„Ø§Ù…ØªÙƒ Ù‡ÙŠ Ø§Ù„Ø£Ù‡Ù…. Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªØ£ÙƒØ¯Ù‹Ø§ØŒ ÙØ§Ù„Ø£ÙØ¶Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø®ØªØµ.',
                    gemini_error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
                    ok: 'Ù…ÙˆØ§ÙÙ‚'
                },
                en: {
                    lang_toggle: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                    sallehly_ar: 'Sallehly',
                    sallehly_en: '',
                    login_subtitle: 'The easiest way for home maintenance services',
                    full_name_label: 'Full Name',
                    name_placeholder: 'Enter your name',
                    phone_label: 'Phone Number',
                    phone_placeholder: 'Enter your phone number',
                    login_button: 'Login / Sign Up',
                    welcome_message: 'Welcome,',
                    home_subtitle: 'Choose the service you need',
                    request_service_title: 'Request a Service',
                    service_type_label: 'Service Type',
                    address_label: 'Detailed Address',
                    address_placeholder: 'e.g., 10 ... Street, 3rd floor, Apt 5',
                    problem_description_label: 'Problem Description',
                    problem_description_placeholder: 'Write a simple description here...',
                    upload_label: 'Upload a photo or video (optional)',
                    submit_request_button: 'Submit Request',
                    my_requests_title: 'My Requests',
                    nav_home: 'Home',
                    nav_requests: 'My Requests',
                    status_new: 'New',
                    status_in_progress: 'In Progress',
                    status_completed: 'Completed',
                    request_id: 'Request #',
                    no_requests: 'You have no requests yet. Start by ordering a new service!',
                    fill_all_fields: 'Please enter your name and phone number',
                    request_submitted_success: 'Your request has been submitted successfully!',
                    gemini_describe_helper: 'âœ¨ Help Me Describe',
                    gemini_diy_helper: 'âœ¨ Suggest a Quick Fix',
                    gemini_loading: 'Just a moment, the AI is thinking...',
                    gemini_diy_title: 'ğŸ’¡ Quick Fix Suggestions',
                    gemini_safety_warning: 'âš ï¸ Caution! These are suggestions for minor issues only. Your safety is most important. If you are unsure, it is best to wait for a professional technician.',
                    gemini_error: 'An error occurred. Please try again.',
                    ok: 'Ok'
                }
            };

            const services = [
                { id: 'plumbing', name_ar: 'Ø³Ø¨Ø§ÙƒØ©', name_en: 'Plumbing', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />' },
                { id: 'electricity', name_ar: 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡', name_en: 'Electricity', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />' },
                { id: 'ac', name_ar: 'ØªÙƒÙŠÙŠÙ', name_en: 'AC', icon: '<path d="M13.5 3l-10 10.5h7v7.5l10-10.5h-7v-7.5zM12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z" stroke-width="1.5" />' },
                { id: 'carpentry', name_ar: 'Ù†Ø¬Ø§Ø±Ø©', name_en: 'Carpentry', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />' },
                { id: 'painting', name_ar: 'Ø¯Ù‡Ø§Ù†Ø§Øª', name_en: 'Painting', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4H7zm0 0a4 4 0 014-4V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4z" /><path d="M17.5 7a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" />' },
                { id: 'glass', name_ar: 'Ø²Ø¬Ø§Ø¬', name_en: 'Glass', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l-3 3m5.657 5.657l-3-3M4.343 15.657l3-3m5.657-5.657l3 3" />' }
            ];

            // --- FUNCTIONS ---
            
            const showModal = (config) => {
                dom.modal.loading.style.display = config.loading ? 'block' : 'none';
                dom.modal.contentDisplay.style.display = config.loading ? 'none' : 'block';

                if (!config.loading) {
                    dom.modal.title.textContent = config.title || '';
                    dom.modal.body.innerHTML = config.body || '';
                    dom.modal.closeBtn.textContent = translations[state.currentLang].ok;
                }

                dom.modal.container.classList.remove('modal-hidden');
                dom.modal.container.classList.add('modal-visible');
            };

            const hideModal = () => {
                dom.modal.container.classList.add('modal-hidden');
                dom.modal.container.classList.remove('modal-visible');
            };
            
            async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
                const apiKey = ""; // Canvas will provide this
                const apiUrl = `https://generativelenuguagelabs.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return callGeminiAPI(prompt, retries - 1, delay * 2);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    return null;
                }
            }


            const saveState = () => {
                localStorage.setItem('sallehlyState', JSON.stringify(state));
            };

            const loadState = () => {
                const savedState = localStorage.getItem('sallehlyState');
                if (savedState) {
                    state = JSON.parse(savedState);
                }
            };

            const setLanguage = (lang) => {
                state.currentLang = lang;
                dom.html.lang = lang;
                dom.html.dir = lang === 'ar' ? 'rtl' : 'ltr';

                const oppositeLang = lang === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
                dom.langToggle.textContent = oppositeLang;
                dom.loginLangToggle.textContent = oppositeLang;

                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });

                document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                    const key = el.dataset.translateKeyPlaceholder;
                     if (translations[lang][key]) {
                        el.placeholder = translations[lang][key];
                    }
                });
                
                renderServices();
                renderMyRequests();
                updateActiveNavButton();

                saveState();
            };

            const navigateTo = (screenName) => {
                state.currentScreen = screenName;
                Object.values(dom.screens).forEach(screen => {
                    screen.classList.remove('visible-screen');
                    screen.classList.add('hidden-screen');
                });
                dom.screens[screenName].classList.add('visible-screen');
                dom.screens[screenName].classList.remove('hidden-screen');

                const isLoginPage = screenName === 'login';
                dom.header.classList.toggle('hidden', isLoginPage);
                dom.footer.classList.toggle('hidden', isLoginPage);
                
                const isHomePage = screenName === 'home' || screenName === 'myRequests';
                dom.backButton.classList.toggle('hidden', isHomePage || isLoginPage);
                
                updateActiveNavButton();
            };
            
            const handleLogin = () => {
                const name = dom.loginForm.name.value.trim();
                const phone = dom.loginForm.phone.value.trim();

                if (!name || !phone) {
                    dom.loginForm.error.textContent = translations[state.currentLang].fill_all_fields;
                    return;
                }

                dom.loginForm.error.textContent = '';
                state.currentUser = { name, phone };
                dom.userNameDisplay.textContent = name;
                saveState();
                navigateTo('home');
            };

            const renderServices = () => {
                dom.servicesGrid.innerHTML = '';
                services.forEach(service => {
                    const card = document.createElement('div');
                    card.className = 'service-card bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all';
                    card.dataset.serviceId = service.id;
                    card.innerHTML = `
                        <div class="bg-sky-100 rounded-full p-4 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-sky-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                ${service.icon}
                            </svg>
                        </div>
                        <h3 class="font-bold text-slate-800">${state.currentLang === 'ar' ? service.name_ar : service.name_en}</h3>
                    `;
                    card.addEventListener('click', () => handleServiceClick(service));
                    dom.servicesGrid.appendChild(card);
                });
            };

            const handleServiceClick = (service) => {
                dom.requestForm.form.reset();
                dom.requestForm.serviceTypeHidden.value = service.id;
                dom.requestForm.serviceTypeDisplay.textContent = state.currentLang === 'ar' ? service.name_ar : service.name_en;
                navigateTo('requestForm');
            };

            const handleSubmitRequest = (e) => {
                e.preventDefault();
                const newRequest = {
                    id: Date.now(),
                    phone: state.currentUser.phone,
                    serviceId: dom.requestForm.serviceTypeHidden.value,
                    address: dom.requestForm.address.value.trim(),
                    description: dom.requestForm.description.value.trim(),
                    media: dom.requestForm.mediaUpload.files[0] ? dom.requestForm.mediaUpload.files[0].name : null,
                    status: 'new',
                    date: new Date().toISOString(),
                };
                
                console.log('New Request Submitted:', newRequest);
                
                state.requests.unshift(newRequest);
                saveState();

                showModal({ title: translations[state.currentLang].request_submitted_success, body: '' });
                
                renderMyRequests();
                navigateTo('myRequests');
            };

            const renderMyRequests = () => {
                dom.requestsList.innerHTML = '';
                const userRequests = state.requests.filter(req => req.phone === state.currentUser?.phone);

                if (userRequests.length === 0) {
                    dom.requestsList.innerHTML = `<p class="text-center text-slate-500 p-8">${translations[state.currentLang].no_requests}</p>`;
                    return;
                }

                userRequests.forEach(req => {
                    const service = services.find(s => s.id === req.serviceId);
                    if (!service) return;

                    const statusClasses = {
                        new: 'bg-blue-100 text-blue-800',
                        in_progress: 'bg-orange-100 text-orange-800',
                        completed: 'bg-green-100 text-green-800',
                    };
                    const statusText = translations[state.currentLang][`status_${req.status}`];

                    const requestCard = document.createElement('div');
                    requestCard.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200';
                    requestCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-800">${state.currentLang === 'ar' ? service.name_ar : service.name_en}</h4>
                                <p class="text-sm text-slate-500">${translations[state.currentLang].request_id} ${req.id}</p>
                                <p class="text-sm text-slate-600 mt-2">${req.description}</p>
                            </div>
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${statusClasses[req.status]}">${statusText}</span>
                        </div>
                        <p class="text-xs text-slate-400 mt-3 text-left rtl:text-right">${new Date(req.date).toLocaleString([], {dateStyle: 'short', timeStyle: 'short'})}</p>
                    `;
                    dom.requestsList.appendChild(requestCard);
                });
            };
            
            const handleDescribeHelper = async () => {
                const userInput = dom.requestForm.description.value.trim();
                if (!userInput) return;

                showModal({ loading: true });
                const lang = state.currentLang === 'ar' ? 'Arabic' : 'English';
                const prompt = `You are a helpful assistant for a home maintenance app in Egypt. A user needs help describing their problem. Take their simple input and expand it into a clear, detailed description for a technician. Keep it concise. User input: "${userInput}". Language: ${lang}.`;
                
                const result = await callGeminiAPI(prompt);
                hideModal();

                if (result) {
                    dom.requestForm.description.value = result;
                } else {
                    showModal({ title: 'Error', body: translations[state.currentLang].gemini_error });
                }
            };
            
            const handleDiyHelper = async () => {
                const description = dom.requestForm.description.value.trim();
                if (!description) return;
                
                showModal({ loading: true });
                const service = services.find(s => s.id === dom.requestForm.serviceTypeHidden.value);
                const serviceName = state.currentLang === 'ar' ? service.name_ar : service.name_en;
                const lang = state.currentLang === 'ar' ? 'Arabic' : 'English';

                const prompt = `You are a helpful home maintenance assistant in Egypt. Based on the following service request, provide simple, safe, step-by-step DIY suggestions a user could try before a professional arrives. Start with a clear safety warning. If the problem sounds complex or dangerous, strongly advise waiting for a professional. Use simple language and markdown for lists. Service: "${serviceName}". Problem: "${description}". Provide the response in ${lang}.`;
                
                const result = await callGeminiAPI(prompt);

                if (result) {
                    const safetyWarning = `<p class="mb-3 p-2 bg-yellow-100 text-yellow-800 rounded-md text-xs">${translations[state.currentLang].gemini_safety_warning}</p>`;
                    // Basic markdown to HTML conversion
                    const formattedResult = safetyWarning + result
                        .replace(/\n\*/g, '<br>â€¢')
                        .replace(/\n/g, '<br>');
                    showModal({ 
                        title: translations[state.currentLang].gemini_diy_title,
                        body: formattedResult
                    });
                } else {
                    showModal({ title: 'Error', body: translations[state.currentLang].gemini_error });
                }
            };

            const updateActiveNavButton = () => {
                dom.navButtons.forEach(btn => {
                    if (btn.dataset.target.startsWith(state.currentScreen)) {
                        btn.classList.remove('text-slate-500');
                        btn.classList.add('text-sky-700');
                    } else {
                        btn.classList.add('text-slate-500');
                        btn.classList.remove('text-sky-700');
                    }
                });
            };

            // --- INITIALIZATION & EVENT LISTENERS ---

            const init = () => {
                loadState();
                setLanguage(state.currentLang);

                if (state.currentUser) {
                    dom.userNameDisplay.textContent = state.currentUser.name;
                    navigateTo('home');
                    renderMyRequests();
                } else {
                    navigateTo('login');
                }
                
                dom.langToggle.addEventListener('click', () => setLanguage(state.currentLang === 'ar' ? 'en' : 'ar'));
                dom.loginLangToggle.addEventListener('click', () => setLanguage(state.currentLang === 'ar' ? 'en' : 'ar'));
                dom.loginForm.button.addEventListener('click', handleLogin);
                dom.navButtons.forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.target)));
                dom.backButton.addEventListener('click', () => navigateTo('home'));
                dom.requestForm.form.addEventListener('submit', handleSubmitRequest);
                dom.modal.closeBtn.addEventListener('click', hideModal);
                dom.requestForm.describeHelperBtn.addEventListener('click', handleDescribeHelper);
                dom.requestForm.diyHelperBtn.addEventListener('click', handleDiyHelper);
            };
            
            init();
        });
    </script>

</body>
</html>

