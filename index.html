import React, { useState, useEffect } from 'react';
// Firebase imports - you'll need to install firebase: npm install firebase
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged 
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc, 
    collection, 
    addDoc, 
    query, 
    where, 
    getDocs,
    updateDoc,
    deleteDoc,
    onSnapshot
} from 'firebase/firestore';

// --- IMPORTANT: Firebase Configuration ---
// 1. Go to your Firebase project console.
// 2. Go to Project Settings -> General tab.
// 3. Under "Your apps", click the web icon (</>) to get your config.
// 4. Copy the config object and paste it here.
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Icons (as SVG components) ---
const WrenchIcon = () => (
    <svg className="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 18.75V8.25A2.652 2.652 0 0018.354 6L12.58 3.097a2.652 2.652 0 00-2.16 0L4.646 6A2.652 2.652 0 003 8.25v10.5A2.652 2.652 0 005.75 21l5.67-5.83z" />
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 21V11.25m0 0l-5.67-5.83m5.67 5.83l5.67-5.83" />
    </svg>
);

// --- Main App Component ---
export default function App() {
    const [user, setUser] = useState(null);
    const [userData, setUserData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState('login'); // login, register, dashboard
    const [theme, setTheme] = useState({ primary: 'blue', secondary: 'orange' }); // Default theme

    useEffect(() => {
        // Listen for theme changes from admin settings in Firestore
        const settingsDocRef = doc(db, 'settings', 'theme');
        const unsubscribeTheme = onSnapshot(settingsDocRef, (docSnap) => {
            if (docSnap.exists()) {
                setTheme(docSnap.data());
            }
        });

        // Listen for authentication state changes
        const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
                setUser(currentUser);
                const userDocRef = doc(db, 'users', currentUser.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    setUserData({ uid: currentUser.uid, ...docSnap.data() });
                } else {
                    console.error("User data not found in Firestore!");
                }
                setCurrentPage('dashboard');
            } else {
                setUser(null);
                setUserData(null);
                setCurrentPage('login');
            }
            setLoading(false);
        });

        return () => {
            unsubscribeAuth();
            unsubscribeTheme();
        };
    }, []);

    const handleSignOut = async () => {
        await signOut(auth);
    };
    
    // --- Render Logic ---
    if (loading) {
        return <div className="min-h-screen flex items-center justify-center bg-gray-100">Loading...</div>;
    }

    const renderPage = () => {
        if (currentPage === 'dashboard' && userData) {
            switch (userData.role) {
                case 'client':
                    return <ClientDashboard user={user} userData={userData} onSignOut={handleSignOut} theme={theme} />;
                case 'technician':
                    return <TechnicianDashboard user={user} userData={userData} onSignOut={handleSignOut} theme={theme} />;
                case 'admin':
                    return <AdminDashboard user={user} userData={userData} onSignOut={handleSignOut} theme={theme} />;
                default:
                    return <AuthPage setCurrentPage={setCurrentPage} theme={theme} />;
            }
        } else {
            return <AuthPage currentPage={currentPage} setCurrentPage={setCurrentPage} theme={theme} />;
        }
    };

    return <div className="antialiased text-gray-800">{renderPage()}</div>;
}

// --- Authentication Page ---
function AuthPage({ currentPage, setCurrentPage, theme }) {
    const [isLogin, setIsLogin] = useState(currentPage === 'login');

    const toggleAuthMode = () => {
        setIsLogin(!isLogin);
        setCurrentPage(isLogin ? 'register' : 'login');
    };
    
    const colorStyles = {
        primaryBg: `bg-${theme.primary}-600`,
        primaryHoverBg: `hover:bg-${theme.primary}-700`,
        primaryText: `text-${theme.primary}-600`,
        primaryHoverText: `hover:text-${theme.primary}-700`,
        primaryRing: `focus:ring-${theme.primary}-500`,
        primaryBorder: `focus:border-${theme.primary}-500`,
    };

    return (
        <div className="min-h-screen bg-gray-100 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
            <div className="sm:mx-auto sm:w-full sm:max-w-md">
                <div className="flex justify-center">
                    <WrenchIcon />
                </div>
                <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    {isLogin ? 'Sign in to your account' : 'Create a new account'}
                </h2>
                <p className="mt-2 text-center text-sm text-gray-600">
                    Or{' '}
                    <button onClick={toggleAuthMode} className={`font-medium ${colorStyles.primaryText} ${colorStyles.primaryHoverText}`}>
                        {isLogin ? 'create a new account' : 'sign in to your account'}
                    </button>
                </p>
            </div>

            <div className="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
                <div className="bg-white py-8 px-4 shadow-xl sm:rounded-lg sm:px-10">
                    {isLogin ? <LoginForm colorStyles={colorStyles} /> : <RegisterForm colorStyles={colorStyles} />}
                </div>
            </div>
        </div>
    );
}

// --- Login Form ---
function LoginForm({ colorStyles }) {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        try {
            // Admin hardcoded login
            if (email === 'admin@sallehly.com' && password === 'admin123') {
                const adminUID = 'ADMIN_USER_UID_PLACEHOLDER'; // In a real app, this should be a secure, known UID
                await signInWithEmailAndPassword(auth, email, password).catch(async (err) => {
                    if (err.code === 'auth/user-not-found') {
                        // Create admin user if it doesn't exist
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await setDoc(doc(db, 'users', userCredential.user.uid), {
                            email: userCredential.user.email,
                            role: 'admin',
                            name: 'Admin User'
                        });
                    } else {
                        throw err;
                    }
                });
            } else {
                await signInWithEmailAndPassword(auth, email, password);
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <form className="space-y-6" onSubmit={handleLogin}>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            <div>
                <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email address</label>
                <input id="email" name="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className={`mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none ${colorStyles.primaryRing} ${colorStyles.primaryBorder} sm:text-sm`} />
            </div>
            <div>
                <label htmlFor="password" className="block text-sm font-medium text-gray-700">Password</label>
                <input id="password" name="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} required className={`mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none ${colorStyles.primaryRing} ${colorStyles.primaryBorder} sm:text-sm`} />
            </div>
            <div>
                <button type="submit" disabled={loading} className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ${colorStyles.primaryBg} ${colorStyles.primaryHoverBg} focus:outline-none focus:ring-2 focus:ring-offset-2 ${colorStyles.primaryRing}`}>
                    {loading ? 'Signing in...' : 'Sign in'}
                </button>
            </div>
        </form>
    );
}

// --- Registration Form ---
function RegisterForm({ colorStyles }) {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [name, setName] = useState('');
    const [phone, setPhone] = useState('');
    const [role, setRole] = useState('client');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleRegister = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            // Add user details to Firestore
            await setDoc(doc(db, 'users', user.uid), {
                name,
                email,
                phone,
                role,
                createdAt: new Date(),
            });
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <form className="space-y-6" onSubmit={handleRegister}>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
             <div>
                <label htmlFor="name" className="block text-sm font-medium text-gray-700">Full Name</label>
                <input id="name" name="name" type="text" value={name} onChange={(e) => setName(e.target.value)} required className={`mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none ${colorStyles.primaryRing} ${colorStyles.primaryBorder} sm:text-sm`} />
            </div>
            <div>
                <label htmlFor="email-register" className="block text-sm font-medium text-gray-700">Email address</label>
                <input id="email-register" name="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className={`mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none ${colorStyles.primaryRing} ${colorStyles.primaryBorder} sm:text-sm`} />
            </div>
             <div>
                <label htmlFor="phone" className="block text-sm font-medium text-gray-700">Phone Number</label>
                <input id="phone" name="phone" type="tel" value={phone} onChange={(e) => setPhone(e.target.value)} required className={`mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none ${colorStyles.primaryRing} ${colorStyles.primaryBorder} sm:text-sm`} />
            </div>
            <div>
                <label htmlFor="password-register" className="block text-sm font-medium text-gray-700">Password</label>
                <input id="password-register" name="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} required className={`mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none ${colorStyles.primaryRing} ${colorStyles.primaryBorder} sm:text-sm`} />
            </div>
            <div>
                <label className="block text-sm font-medium text-gray-700">Register as a</label>
                <div className="mt-2 flex space-x-4">
                    <label className="flex items-center">
                        <input type="radio" name="role" value="client" checked={role === 'client'} onChange={(e) => setRole(e.target.value)} className={`form-radio h-4 w-4 ${colorStyles.primaryText}`} />
                        <span className="ml-2 text-sm text-gray-700">Client</span>
                    </label>
                    <label className="flex items-center">
                        <input type="radio" name="role" value="technician" checked={role === 'technician'} onChange={(e) => setRole(e.target.value)} className={`form-radio h-4 w-4 ${colorStyles.primaryText}`} />
                        <span className="ml-2 text-sm text-gray-700">Technician</span>
                    </label>
                </div>
            </div>
            <div>
                <button type="submit" disabled={loading} className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ${colorStyles.primaryBg} ${colorStyles.primaryHoverBg} focus:outline-none focus:ring-2 focus:ring-offset-2 ${colorStyles.primaryRing}`}>
                    {loading ? 'Creating account...' : 'Register'}
                </button>
            </div>
        </form>
    );
}


// --- DASHBOARD COMPONENTS ---

// --- Client Dashboard ---
function ClientDashboard({ userData, onSignOut, theme }) {
    const [requests, setRequests] = useState([]);
    const [view, setView] = useState('myRequests'); // myRequests, newRequest
    
    useEffect(() => {
        const q = query(collection(db, "requests"), where("clientId", "==", userData.uid));
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const requestsData = [];
            querySnapshot.forEach((doc) => {
                requestsData.push({ id: doc.id, ...doc.data() });
            });
            setRequests(requestsData);
        });
        return () => unsubscribe();
    }, [userData.uid]);

    return (
        <DashboardLayout user={userData} onSignOut={onSignOut} theme={theme}>
            <div className="flex justify-between items-center mb-6">
                 <h1 className="text-2xl font-bold">Client Dashboard</h1>
                 <div>
                    <button onClick={() => setView('myRequests')} className={`px-4 py-2 rounded-md text-sm font-medium mr-2 ${view === 'myRequests' ? `bg-${theme.primary}-600 text-white` : 'bg-gray-200'}`}>My Requests</button>
                    <button onClick={() => setView('newRequest')} className={`px-4 py-2 rounded-md text-sm font-medium ${view === 'newRequest' ? `bg-${theme.primary}-600 text-white` : 'bg-gray-200'}`}>New Request</button>
                 </div>
            </div>
            {view === 'myRequests' ? <RequestList requests={requests} theme={theme} /> : <NewRequestForm userData={userData} setView={setView} theme={theme} />}
        </DashboardLayout>
    );
}

function NewRequestForm({ userData, setView, theme }) {
    const [serviceType, setServiceType] = useState('plumbing');
    const [description, setDescription] = useState('');
    const [address, setAddress] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
            await addDoc(collection(db, "requests"), {
                clientId: userData.uid,
                clientName: userData.name,
                clientPhone: userData.phone,
                serviceType,
                description,
                address,
                status: 'New',
                createdAt: new Date(),
                technicianId: null, // To be assigned by admin or auto-assigner
            });
            setView('myRequests');
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };
    
    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-bold mb-4">Submit a New Service Request</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
                 <div>
                    <label className="block text-sm font-medium text-gray-700">Address</label>
                    <input type="text" value={address} onChange={(e) => setAddress(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700">Service Type</label>
                    <select value={serviceType} onChange={(e) => setServiceType(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="plumbing">Plumbing</option>
                        <option value="electricity">Electricity</option>
                        <option value="ac">AC</option>
                        <option value="carpentry">Carpentry</option>
                        <option value="painting">Painting</option>
                        <option value="glass">Glass Repair</option>
                    </select>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700">Description of Issue</label>
                    <textarea value={description} onChange={(e) => setDescription(e.target.value)} required rows="4" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <button type="submit" disabled={loading} className={`w-full py-2 px-4 rounded-md text-white bg-${theme.primary}-600 hover:bg-${theme.primary}-700`}>
                    {loading ? 'Submitting...' : 'Submit Request'}
                </button>
            </form>
        </div>
    );
}

function RequestList({ requests, theme }) {
    if (requests.length === 0) {
        return <p>You have no service requests.</p>;
    }
    
    const getStatusColor = (status) => {
        switch(status) {
            case 'New': return `bg-blue-100 text-blue-800`;
            case 'In Progress': return `bg-${theme.secondary}-100 text-${theme.secondary}-800`;
            case 'Completed': return 'bg-green-100 text-green-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }
    
    return (
        <div className="space-y-4">
            {requests.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()).map(req => (
                <div key={req.id} className="bg-white p-4 rounded-lg shadow-md flex justify-between items-center">
                    <div>
                        <p className="font-bold capitalize">{req.serviceType}</p>
                        <p className="text-sm text-gray-600">{req.description}</p>
                        <p className="text-xs text-gray-400 mt-1">{req.createdAt.toDate().toLocaleString()}</p>
                    </div>
                    <span className={`text-sm font-bold px-3 py-1 rounded-full ${getStatusColor(req.status)}`}>
                        {req.status}
                    </span>
                </div>
            ))}
        </div>
    );
}


// --- Technician Dashboard ---
function TechnicianDashboard({ userData, onSignOut, theme }) {
    const [tasks, setTasks] = useState([]);

    useEffect(() => {
        const q = query(collection(db, "requests"), where("technicianId", "==", userData.uid));
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const tasksData = [];
            querySnapshot.forEach((doc) => {
                tasksData.push({ id: doc.id, ...doc.data() });
            });
            setTasks(tasksData);
        });
        return () => unsubscribe();
    }, [userData.uid]);
    
    const updateTaskStatus = async (taskId, newStatus) => {
        const taskDocRef = doc(db, 'requests', taskId);
        await updateDoc(taskDocRef, { status: newStatus });
    };

    return (
        <DashboardLayout user={userData} onSignOut={onSignOut} theme={theme}>
            <h1 className="text-2xl font-bold mb-6">Assigned Tasks</h1>
            <div className="space-y-4">
            {tasks.length > 0 ? tasks.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()).map(task => (
                <div key={task.id} className="bg-white p-4 rounded-lg shadow-md">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="font-bold capitalize text-lg">{task.serviceType}</p>
                            <p className="text-sm text-gray-700 mt-1"><b>Client:</b> {task.clientName}</p>
                            <p className="text-sm text-gray-700"><b>Phone:</b> {task.clientPhone}</p>
                            <p className="text-sm text-gray-700"><b>Address:</b> {task.address}</p>
                            <p className="text-sm text-gray-600 mt-2"><b>Issue:</b> {task.description}</p>
                        </div>
                        <div className="text-right">
                           <p className="text-xs text-gray-400">{task.createdAt.toDate().toLocaleString()}</p>
                           <p className="font-bold mt-2">Status: {task.status}</p>
                        </div>
                    </div>
                     <div className="mt-4 pt-4 border-t flex space-x-2">
                        <button onClick={() => updateTaskStatus(task.id, 'In Progress')} className={`px-3 py-1 text-sm rounded-md text-white bg-${theme.secondary}-500 hover:bg-${theme.secondary}-600`}>Set In Progress</button>
                        <button onClick={() => updateTaskStatus(task.id, 'Completed')} className="px-3 py-1 text-sm rounded-md text-white bg-green-500 hover:bg-green-600">Set Completed</button>
                     </div>
                </div>
            )) : <p>No tasks assigned to you.</p>}
            </div>
        </DashboardLayout>
    );
}

// --- Admin Dashboard ---
function AdminDashboard({ userData, onSignOut, theme }) {
     const [view, setView] = useState('requests'); // requests, users, settings
     
    return (
        <DashboardLayout user={userData} onSignOut={onSignOut} theme={theme}>
             <h1 className="text-2xl font-bold mb-6">Admin Dashboard</h1>
             <div className="mb-6 border-b">
                 <nav className="-mb-px flex space-x-8">
                    <button onClick={() => setView('requests')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${view === 'requests' ? `border-${theme.primary}-500 text-${theme.primary}-600` : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Manage Requests</button>
                    <button onClick={() => setView('users')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${view === 'users' ? `border-${theme.primary}-500 text-${theme.primary}-600` : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Manage Users</button>
                    <button onClick={() => setView('settings')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${view === 'settings' ? `border-${theme.primary}-500 text-${theme.primary}-600` : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Website Settings</button>
                 </nav>
             </div>
             {view === 'requests' && <ManageRequests theme={theme} />}
             {view === 'users' && <ManageUsers theme={theme} />}
             {view === 'settings' && <WebsiteSettings theme={theme} />}
        </DashboardLayout>
    );
}

function ManageRequests({ theme }) {
    const [requests, setRequests] = useState([]);
    const [technicians, setTechnicians] = useState([]);

    useEffect(() => {
        const fetchTechnicians = async () => {
             const q = query(collection(db, "users"), where("role", "==", "technician"));
             const querySnapshot = await getDocs(q);
             const techData = [];
             querySnapshot.forEach(doc => techData.push({id: doc.id, ...doc.data()}));
             setTechnicians(techData);
        };
        fetchTechnicians();
        
        const unsubscribe = onSnapshot(collection(db, 'requests'), (snapshot) => {
            const reqData = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            setRequests(reqData);
        });
        
        return () => unsubscribe();
    }, []);

    const assignTechnician = async (requestId, technicianId) => {
        if (!technicianId) return;
        const requestDocRef = doc(db, 'requests', requestId);
        await updateDoc(requestDocRef, { technicianId });
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-bold mb-4">All Service Requests</h2>
            <div className="space-y-4">
                {requests.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()).map(req => (
                    <div key={req.id} className="p-4 border rounded-md">
                        <p><b>Service:</b> {req.serviceType}</p>
                        <p><b>Client:</b> {req.clientName}</p>
                        <p><b>Status:</b> {req.status}</p>
                        <div className="mt-2">
                            <label className="text-sm">Assign Technician:</label>
                            <select 
                                defaultValue={req.technicianId || ""}
                                onChange={(e) => assignTechnician(req.id, e.target.value)}
                                className="ml-2 border-gray-300 rounded-md shadow-sm"
                            >
                                <option value="">- Select -</option>
                                {technicians.map(tech => (
                                    <option key={tech.id} value={tech.id}>{tech.name}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function ManageUsers({ theme }) {
    const [users, setUsers] = useState([]);

    useEffect(() => {
         const unsubscribe = onSnapshot(collection(db, 'users'), (snapshot) => {
            const usersData = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            setUsers(usersData);
        });
        return () => unsubscribe();
    }, []);
    
    // In a real app, deleting a user from Firestore does not delete them from Firebase Auth.
    // This requires a Cloud Function for security reasons.
    const handleDeleteUser = async (userId) => {
        if (window.confirm('Are you sure? This action is for demonstration and only removes user from database.')) {
            await deleteDoc(doc(db, "users", userId));
        }
    };
    
    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
             <h2 className="text-xl font-bold mb-4">All Users</h2>
             <div className="divide-y">
                 {users.map(u => (
                     <div key={u.id} className="p-2 flex justify-between items-center">
                         <div>
                            <p className="font-semibold">{u.name} ({u.role})</p>
                            <p className="text-sm text-gray-500">{u.email}</p>
                         </div>
                         <button onClick={() => handleDeleteUser(u.id)} className="text-red-500 hover:text-red-700 text-sm">Delete</button>
                     </div>
                 ))}
             </div>
        </div>
    );
}

function WebsiteSettings({ theme }) {
    const [primaryColor, setPrimaryColor] = useState(theme.primary);
    const [secondaryColor, setSecondaryColor] = useState(theme.secondary);
    const [message, setMessage] = useState('');

    const handleSave = async () => {
        setMessage('');
        try {
            const settingsDocRef = doc(db, 'settings', 'theme');
            await setDoc(settingsDocRef, { primary: primaryColor, secondary: secondaryColor });
            setMessage('Theme saved successfully!');
            setTimeout(() => setMessage(''), 3000);
        } catch (error) {
            setMessage('Error saving theme.');
        }
    };

    const colors = ['slate', 'gray', 'zinc', 'neutral', 'stone', 'red', 'orange', 'amber', 'yellow', 'lime', 'green', 'emerald', 'teal', 'cyan', 'sky', 'blue', 'indigo', 'violet', 'purple', 'fuchsia', 'pink', 'rose'];

    return (
         <div className="bg-white p-6 rounded-lg shadow-md">
             <h2 className="text-xl font-bold mb-4">Customize Website</h2>
             {message && <p className="text-green-600 mb-4">{message}</p>}
             <div className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700">Primary Color</label>
                    <select value={primaryColor} onChange={(e) => setPrimaryColor(e.target.value)} className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        {colors.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                </div>
                 <div>
                    <label className="block text-sm font-medium text-gray-700">Secondary Color</label>
                    <select value={secondaryColor} onChange={(e) => setSecondaryColor(e.target.value)} className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        {colors.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                </div>
                 <div>
                     <button onClick={handleSave} className={`w-full py-2 px-4 rounded-md text-white bg-${theme.primary}-600 hover:bg-${theme.primary}-700`}>Save Settings</button>
                 </div>
             </div>
        </div>
    );
}


// --- Generic Dashboard Layout ---
function DashboardLayout({ user, onSignOut, children, theme }) {
    return (
        <div className="min-h-screen bg-gray-100">
            <header className="bg-white shadow-md">
                <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between items-center h-16">
                        <div className="flex items-center space-x-2">
                           <WrenchIcon />
                           <span className={`text-xl font-bold text-${theme.primary}-600`}>Sallehly</span>
                        </div>
                        <div className="flex items-center space-x-4">
                           <span className="text-sm">Welcome, <b>{user.name}</b> ({user.role})</span>
                           <button onClick={onSignOut} className="text-sm font-medium text-gray-600 hover:text-gray-900">Sign Out</button>
                        </div>
                    </div>
                </div>
            </header>
            <main className="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {children}
            </main>
        </div>
    );
}
